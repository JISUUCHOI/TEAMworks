<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
"-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="approveMapper">

	<resultMap id="empInfoResultSet" type="Employee">
		<id column="emp_id" property="empId"/>
		<result column="emp_name" property="empName"/>
		<result column="dept_code" property="deptCode" />
		<result column="dept_name" property="deptName" />
		<result column="job_code" property="jobCode" />
		<result column="job_name" property="jobName" />
	</resultMap>
	
	
	<resultMap id="reqApprovalResultSet" type="Document">
		<id column="doc_no" property="docNo"/>
		<result column="emp_id" property="empId"/>
		<result column="doc_sc" property="docSc"/>
		<result column="doc_status" property="docStatus"/>
		<result column="doc_title" property="docTitle"/>
		<result column="doc_reference" property="docReference"/>
		<result column="doc_date" property="docDate"/>
		<result column="doc_end" property="docEnd"/>
		<result column="doc_department" property="docDepartment"/>
		
		<result column="fe_sq" property="feSq"/>
		<result column="fe_relation" property="feRelation"/>
		<result column="fe_name" property="feName"/>
		<result column="fe_start" property="feStart"/>
		<result column="fe_end" property="feEnd"/>
		<result column="fe_place" property="fePlace"/>
		<result column="fe_price" property="fePrice"/>
		<result column="fe_bank" property="feBank"/>
		<result column="fe_account" property="feAccount"/>
		<result column="fe_account_name" property="feAccountName"/>
		
		<result column="vc_sq" property="vcSq"/>
		<result column="vc_day" property="vcDay"/>
		<result column="vc_start" property="vcStart"/>
		<result column="vc_end" property="vcEnd"/>
		<result column="vc_count" property="vcCount"/>
		<result column="vc_content" property="vcContent"/>
		
		<result column="approve_status" property="approveStatus"/>
		<result column="emp_name" property="empName"/>
		
	</resultMap>
	
	<resultMap id="freLineResultSet" type="fal">
		<result column="line_name" property="lineName"/>
		<result column="emp_id" property="empId"/>
		<result column="authorized_empid" property="authorizedEmpid"/>
		<result column="emp_name" property="empName"/>
		<result column="dept_name" property="deptName"/>
		<result column="approve_step" property="approveStep"/>
	</resultMap>


	<select id="selectEmpInfo" parameterType="string" resultMap="empInfoResultSet">
		select emp_id, emp_name, dept_name
		  from employee
		  join department using(dept_code)
		 where emp_id = #{empId} and emp_status = 'Y'
	</select>

	<select id="selectDeptName" resultMap="empInfoResultSet">
		select dept_code, dept_name
		  from department
		 order by dept_code
	</select>


	<select id="selectOrgChart" resultMap="empInfoResultSet">
		select emp_id, emp_name, e.dept_code, dept_name, e.job_code, job_name
		  from employee e
		  join department d on(e.dept_code = d.dept_code)
		  join job j on(e.job_code = j.job_code)
		 where emp_status = 'Y'
         order by e.dept_code, e.job_code
	</select>

	<select id="selectEmpSch" parameterType="asc" resultMap="empInfoResultSet">
		select emp_id, emp_name, e.dept_code, dept_name, e.job_code, job_name
		  from employee e
		  join department d on(e.dept_code = d.dept_code)
		  join job j on(e.job_code = j.job_code)
		 where emp_status = 'Y'
		 	<choose>
		 		<when test="deptName != null">
		 					and dept_name like '%' || #{deptName} || '%'
		 			order by job_code
		 		</when>	
		 		<when test="jobName != null">
		 					and job_name like '%' || #{jobName} || '%'
		 			order by dept_code
		 		</when>
		 		<when test="empName != null">
		 					and emp_name like '%' || #{empName} || '%'
		 			order by dept_code, job_code
		 		</when>
		 	</choose>
	</select>



	<insert id="insertFamilyEvent" parameterType="Document">
		insert into FAMILY_EVENT
		values(#{docNo}, #{empId}, #{docSc}, 0, #{docTitle}, #{docReference}, #{docDate}, #{docEnd}, #{docDepartment}, #{feSq}, #{feRelation}, #{feName}, #{feStart}, #{feEnd}, #{fePlace}, #{fePrice}, #{feBank}, #{feAccount}, #{feAccountName})
	</insert>
	
	<insert id="insertVacation" parameterType="Document">
		insert into vacation
		values(#{docNo}, #{empId}, #{docSc}, 0, #{docTitle}, #{docReference}, #{docDate}, #{docEnd}, #{docDepartment}, #{vcSq}, #{vcDay}, #{vcStart}, #{vcEnd}, #{vcCount}, #{vcContent})
	</insert>
	
	<insert id="insertApproveLine" parameterType="al">
		insert into approve_line
		values(#{approverEmpid}, #{docNo}, #{approveStep}, #{approveReject}, #{approveStatus}, null, null)
	</insert>
	
	
	
	
	<select id="selectLineName" parameterType="fal" resultType="_int">
		select count(*)
		  from frequent_approval_line
		 where emp_id = #{empId} and line_name = #{lineName}
	</select>
	
	<insert id="insertFreLine" parameterType="fal">
		insert into frequent_approval_line
		values(#{lineName}, #{empId}, #{authorizedEmpid}, #{approveStep})
	</insert>
	
	<select id="selectFreLine" parameterType="String" resultMap="freLineResultSet">
		select line_name
		  from frequent_approval_line
		 where emp_id = #{empId}
		 group by line_name
		 order by line_name
	</select>

	<select id="selectLineDetail" parameterType="fal" resultMap="freLineResultSet">
		select f.line_name, f.emp_id, f.authorized_empid, e.emp_name, d.dept_name, f.approve_step
		  from frequent_approval_line f
		  join employee e on(f.authorized_empid = e.emp_id)
		  join department d on(e.dept_code = d.dept_code)
		 where f.emp_id = #{empId} and f.line_name = #{lineName}
		 order by f.approve_step
	</select>

	<delete id="deleteLine" parameterType="fal">
		delete from frequent_approval_line
		 where emp_id = #{empId} and line_name = #{lineName}
	</delete>



	<select id="selectDocList" parameterType="Document" resultMap="reqApprovalResultSet">
		select *
		  from (select *
      			  from (select v.doc_no, v.doc_sc, v.doc_title, v.emp_id, e.emp_name, v.doc_department, v.doc_date, a.approve_status
            			  from vacation v
            			  join approve_line a on(v.doc_no = a.doc_no)
            			  join employee e on(v.emp_id = e.emp_id)
           				 where a.approver_empid=#{empId} and a.approve_status=#{approveStatus}
           				 order by v.doc_date asc)
				UNION ALL
				select *
		  		  from (select f.doc_no, f.doc_sc, f.doc_title, f.emp_id, e.emp_name, f.doc_department, f.doc_date, a.approve_status
              	  		  from family_event f
              	  		  join approve_line a on(f.doc_no = a.doc_no)
              	  		  join employee e on(f.emp_id = e.emp_id)
            	 		 where a.approver_empid=#{empId} and a.approve_status=#{approveStatus}
              	 		 order by f.doc_date asc)
      		  )
		order by doc_date asc
	</select>

</mapper>
